<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<script>
  (function init() {
    if (!window.webkit) return;

    //log handler
    console.log = function (msg) {
      if (typeof msg == 'object') {
        msg = objToString(msg);
      }
      window.webkit.messageHandlers.logHandler.postMessage(msg);
    };

    //error handler
    window.onerror = (msg, url, line, column, error) => {
      const message = {
        message: msg,
        url: url,
        line: line,
        column: column,
        error: JSON.stringify(error)
      }
      window.webkit.messageHandlers.errorHandler.postMessage(message);
    };

    window.onload = (event) => {
      if (typeof start === "function") {
        start();
      } else {
        console.log("Warning â€“ Widget is not loaded from the iOS app");
      }

      announcekit.on("*", function ({data, name}) {
        console.log('AnnounceKit event', name)
        switch (name) {
          case "init":
            window.webkit.messageHandlers.eventTrigger.postMessage({event: "init"});
            break;

          // Called for each widget after the widget has been successfully loaded.
          case "widget-init":

          // Called for each widget after the widget has been opened.
          case "widget-open":

          // Called for each widget after the widget has been opened.
          case "widget-close":
            window.webkit.messageHandlers.eventTrigger.postMessage({widget: data.widget, event: name});
            break;

          // Called when unread post count of specified widget has been updated
          case "widget-unread":
            window.webkit.messageHandlers.updateUnreadCount.postMessage({unread: unread});
            break;

          // Called when the data state of the widget is changed
          // TODO: We can store all state for further usages
          case "widget-state":
            const counter = data.ui.unread || 0;
            window.webkit.messageHandlers.updateUnreadCount.postMessage({unread: counter});
            break;

          default:
            break;
        }
      })
    }
  })()

  function objToString(obj) {
    var str = '';
    for (var p in obj) {
      if (obj.hasOwnProperty(p)) {
        str += p + '::' + obj[p] + '\n';
      }
    }
    return str;
  }
</script>
<script src="https://cdn.announcekit.app/widget-v2.js"></script>
</body>
</html>
